<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CropSevai â€“ AI Treatment Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }

    #severityCenter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-weight: 600;
      color: #374151;
    }

    /* Hide Google Translate UI */
    .goog-logo-link,
    .goog-te-gadget {
      display: none !important;
    }
    body > .skiptranslate {
      display: none !important;
    }

    /* ğŸ”¥ FIX Google Translate Navbar White Space */
html {
  top: 0 !important;
}

body {
  top: 0 !important;
  position: relative !important;
}

/* Force-remove injected translate iframe space */
iframe.goog-te-banner-frame {
  display: none !important;
}

.goog-te-menu-frame {
  display: none !important;
}

/* Prevent layout shift */
.goog-te-combo {
  display: none !important;
}

  </style>
</head>

<body class="bg-gray-50 h-screen overflow-hidden transition-colors duration-500">

<!-- Header -->
<header class="flex items-center justify-between px-8 py-5 
               bg-gradient-to-r from-green-700 to-green-500 text-white shadow-lg">
  <h1 class="text-2xl font-bold flex items-center gap-2">
    ğŸ§  CropSevai â€“ AI Treatment Engine
  </h1>

  <div class="flex items-center gap-4">
    <!-- Back -->
    <a href="crops.html"
       class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 text-white font-semibold 
              rounded-lg shadow hover:shadow-xl hover:scale-105 transition">
      â¬…ï¸ Back
    </a>
    
    <a id="nextFertilizer"
   class="inline-flex items-center gap-2 px-4 py-2 bg-white/20 text-white font-semibold 
          rounded-lg shadow hover:shadow-xl hover:scale-105 transition cursor-pointer">
  â¡ï¸ Next
</a>



    <!-- Language Buttons (ONLY ADDITION) -->
    <div class="flex items-center gap-2 bg-white/20 backdrop-blur-md
                border border-white/30 rounded-xl p-1">
      <button onclick="translateTamil()"
        class="px-4 py-2 rounded-lg text-sm font-semibold
               bg-blue-600 text-white shadow hover:shadow-md transition">
        ğŸŒ Tamil
      </button>
      <button onclick="translateEnglish()"
        class="px-4 py-2 rounded-lg text-sm font-semibold
               bg-white text-gray-800 hover:bg-gray-100 transition">
        ğŸŒ English
      </button>
    </div>

    <!-- Theme Toggle -->
    <button id="themeToggle" class="text-2xl hover:scale-110 transition">ğŸŒ™</button>
  </div>
</header>

<!-- Main Grid -->
<main class="grid grid-cols-12 gap-6 p-6 h-[calc(100vh-5rem)]">
  
  <!-- Crop Info + Diseases -->
  <section class="col-span-8 flex flex-col gap-6 overflow-hidden">
    <div class="bg-white/70 backdrop-blur-md p-6 rounded-xl shadow-lg flex-shrink-0">
      <h1 id="cropName" class="text-2xl font-bold text-gray-800"></h1>
      <p id="cropMeta" class="text-gray-500 mt-2 flex gap-4"></p>
    </div>

    <div class="flex flex-col flex-1 overflow-hidden">
      <h2 class="text-xl font-bold text-gray-700 mb-2">ğŸ¦  Diseases</h2>
      <div id="diseaseBox" class="grid grid-cols-2 gap-4 overflow-auto pr-2"></div>
    </div>
  </section>

  <!-- Analytics Sidebar -->
  <aside class="col-span-4 bg-white/80 backdrop-blur-md p-6 rounded-xl shadow-lg flex flex-col items-center">
    <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“Š Severity Analytics</h3>
    <div class="relative w-48 h-48 flex items-center justify-center">
      <canvas id="severityChart"></canvas>
      <div id="severityCenter"></div>
    </div>
  </aside>
</main>

<!-- Treatment Box -->
<footer class="bg-white/80 backdrop-blur-md p-6 rounded-xl shadow-lg mx-6">
  <div id="box" class="max-w-full"></div>
</footer>

<!-- Hidden Google Translate -->
<div id="google_translate_element" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===========================
   ORIGINAL CODE (UNCHANGED)
=========================== */

const params = new URLSearchParams(window.location.search);
const cropId = params.get("crop_id") || 1;

// Theme toggle
const toggleBtn = document.getElementById("themeToggle");
let darkMode = false;
toggleBtn.onclick = () => {
  darkMode = !darkMode;
  document.body.classList.toggle("bg-gray-900");
  document.body.classList.toggle("text-white");
  toggleBtn.textContent = darkMode ? "â˜€ï¸" : "ğŸŒ™";
};

// Dynamic API URL
const API_BASE_URL = window.location.hostname === 'localhost'
  ? 'http://localhost:5000'
  : window.location.origin;

// Load Crop Info
fetch(`${API_BASE_URL}/api/crops/${cropId}`)
.then(res => res.json())
.then(crop => {
  document.getElementById("cropName").innerText = crop.name;
  document.getElementById("cropMeta").innerHTML =
    `<span>â˜€ï¸ ${crop.season}</span> | <span>ğŸŸ« ${crop.soil_type}</span> `;
});

// Load Diseases
fetch(`${API_BASE_URL}/api/crops/${cropId}/diseases`)
.then(res => res.json())
.then(list => {
  const box = document.getElementById("diseaseBox");
  box.innerHTML = "";

  let severityCounts = { High:0, Medium:0, Low:0 };

  list.forEach(d => {
    severityCounts[d.severity]++;

    const div = document.createElement("div");
    div.className = "p-6 bg-white/70 backdrop-blur-md rounded-xl shadow hover:shadow-xl transition transform hover:-translate-y-1 cursor-pointer border border-gray-200 hover:border-green-400";
    div.innerHTML = `
      <h3 class="font-bold text-green-700 mb-2">${d.disease_name}</h3>
      <p class="text-gray-700 mb-3">${d.symptoms}</p>
      <span class="inline-block px-3 py-1 text-sm font-medium rounded-full
        ${d.severity === 'High' ? 'bg-red-100 text-red-700' :
          d.severity === 'Medium' ? 'bg-yellow-100 text-yellow-700' :
          'bg-green-100 text-green-700'}">
        Severity: ${d.severity}
      </span>
    `;
    div.onclick = () => {
      window.location.href = `treatment.html?disease_id=${d.id}`;
    };
    
    box.appendChild(div);
  });

  // Severity Chart (UNCHANGED)
  const ctx = document.getElementById('severityChart').getContext('2d');
  const total = severityCounts.High + severityCounts.Medium + severityCounts.Low;
  document.getElementById("severityCenter").innerHTML = `
    <div class="text-2xl">${total}</div>
    <div class="text-sm text-gray-500">Diseases</div>
  `;

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['High', 'Medium', 'Low'],
      datasets: [{
        data: [severityCounts.High, severityCounts.Medium, severityCounts.Low],
        backgroundColor: [
          'rgba(220,38,38,0.9)',
          'rgba(245,158,11,0.9)',
          'rgba(22,163,74,0.9)'
        ],
        borderWidth: 4,
        borderColor: '#f9fafb'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '75%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#374151',
            font: { family: 'Inter', size: 12, weight: '500' },
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: '#111827',
          titleColor: '#fff',
          bodyColor: '#d1d5db',
          padding: 10,
          borderColor: '#374151',
          borderWidth: 1
        }
      },
      animation: {
        animateRotate: true,
        animateScale: true
      }
    }
  });
});

/* ===========================
   TRANSLATION (ONLY ADDITION)
=========================== */

function googleTranslateElementInit() {
  new google.translate.TranslateElement(
    { pageLanguage: 'en', includedLanguages: 'en,ta', autoDisplay: false },
    'google_translate_element'
  );
}

function translateTamil() {
  const select = document.querySelector('.goog-te-combo');
  if (!select) return;
  select.value = 'ta';
  select.dispatchEvent(new Event('change'));
  localStorage.setItem('lang', 'ta');
}

function translateEnglish() {
  const select = document.querySelector('.goog-te-combo');
  if (!select) return;
  select.value = 'en';
  select.dispatchEvent(new Event('change'));
  localStorage.setItem('lang', 'en');
}

window.addEventListener("load", () => {
  const lang = localStorage.getItem("lang");
  if (lang) {
    setTimeout(() => {
      const select = document.querySelector(".goog-te-combo");
      if (select) {
        select.value = lang;
        select.dispatchEvent(new Event("change"));
      }
    }, 600);
  }
});


// ğŸ”¥ Remove navbar gap after translation
function removeTranslateGap() {
  document.body.style.top = "0px";
  document.documentElement.style.top = "0px";
}

// Run after language switch
function translateTamil() {
  const select = document.querySelector('.goog-te-combo');
  if (!select) return;
  select.value = 'ta';
  select.dispatchEvent(new Event('change'));
  localStorage.setItem('lang', 'ta');
  setTimeout(removeTranslateGap, 300);
}

function translateEnglish() {
  const select = document.querySelector('.goog-te-combo');
  if (!select) return;
  select.value = 'en';
  select.dispatchEvent(new Event('change'));
  localStorage.setItem('lang', 'en');
  setTimeout(removeTranslateGap, 300);
}

</script>

<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
<script>
  const nextBtn = document.getElementById("nextFertilizer");

  nextBtn.onclick = () => {
    if (!cropId) {
      alert("Crop ID missing");
      return;
    }
    window.location.href = `fertilizer.html?crop_id=${cropId}`;
  };
</script>

</body>
</html>
