<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CropSevai Hub | Smart Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <script>
    if (!localStorage.getItem("token")) {
      window.location.href = "index.html";
    }
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-start:#f6fbfb;
      --bg-end:#eef6f4;
      --muted:#6b7280;
      --accent:#0fb07f;
      --card-bg:rgba(255,255,255,0.98);
    }

    /* Prevent page scrolling ‚Äî fixed layout */
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: linear-gradient(135deg,var(--bg-start),var(--bg-end)); color:#0f172a; }

    /* Sidebar preserved visually (unchanged) */
    .sidebar-fixed { width: 18rem; min-width: 18rem; }

    /* Card base */
    .card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.04);
      box-shadow: 0 12px 30px rgba(2,6,23,0.06);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .card:hover { transform: translateY(-6px); box-shadow: 0 20px 48px rgba(2,6,23,0.09); }

    /* Layout: full height, no scroll */
    .app {
      display: flex;
      height: 100vh;
      gap: 0;
      box-sizing: border-box;
    }

    /* Main area fixed layout */
    .main {
      flex: 1;
      display: grid;
      grid-template-rows: 86px 120px 1fr; /* header, KPI row, content */
      gap: 18px;
      padding: 24px;
      box-sizing: border-box;
      min-width: 0; /* important for flex children to shrink */
    }

    /* Header */
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .title { font-size:30px; font-weight:800; letter-spacing:-0.3px; }
    .subtitle { color:var(--muted); margin-top:6px; font-size:13px; }

    /* KPI row */
    .kpi-row {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:16px;
      align-items:stretch;
    }
    .kpi {
      padding:16px;
      border-left-width:6px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(247,249,250,0.98));
      border-radius:12px;
      min-height: 96px;
      box-sizing: border-box;
    }
    .kpi .meta { color:var(--muted); font-size:13px; }
    .kpi .value { font-size:26px; font-weight:800; color:#0f172a; }
    .kpi .trend { font-size:12px; padding:6px 10px; border-radius:999px; font-weight:700; }

    /* Content area: map + chart */
    .content {
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:18px;
      align-items:stretch;
      min-height: 0; /* allow children to size correctly */
    }

    /* Map card */
    .map-card { padding:16px; display:flex; flex-direction:column; gap:12px; }
    .map-toolbar { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .map-canvas { flex:1; border-radius:10px; overflow:hidden; border:1px solid rgba(15,23,42,0.04); min-height:0; } /* min-height:0 important */

    /* Toggle button */
    .toggle {
      display:inline-flex;
      gap:8px;
      background:transparent;
      border-radius:10px;
      padding:6px;
      align-items:center;
    }
    .toggle button {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.06);
      background:white;
      cursor:pointer;
      font-weight:600;
    }
    .toggle button.active { background: linear-gradient(180deg,var(--accent),#0b8f66); color:white; border-color:transparent; }

    /* Chart card */
    .chart-card { padding:16px; display:flex; flex-direction:column; gap:12px; border-radius:12px; min-height:0; }
    .chart-inner { flex:1; display:flex; align-items:center; justify-content:center; min-height:0; }

    
    /* Small responsive tweaks */
    @media (max-width: 1280px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
      .content { grid-template-columns: 1fr; grid-auto-rows: 1fr 420px; }
    }

    
  </style>
</head>
<body>

<div class="app">

  <!-- SIDEBAR (kept exactly as original visual & markup) -->
  <aside class="sidebar-fixed bg-gradient-to-b from-[#0a3f3c] to-[#032b28] text-white p-6 flex flex-col">
    <h1 class="text-2xl font-bold mb-8">üåø CropSevai Hub</h1>
    <div class="space-y-3 flex-1">
      <a href="dashboard.html" class="block p-4 rounded-xl bg-white/10 hover:bg-white/20 transition">üìä Dashboard</a>
      <a href="crops.html" class="block p-4 rounded-xl hover:bg-white/10 transition">üåæ Crops</a>
      <!-- <a href="disease.html" class="block p-4 rounded-xl hover:bg-white/10 transition">ü¶† Diseases</a>
      <a href="advisory.html" class="block p-4 rounded-xl hover:bg-white/10 transition">‚ö†Ô∏è Advisory</a> -->
    </div>
    <button onclick="logout()" class="mt-auto bg-red-500 hover:bg-red-600 py-3 rounded-xl transition">Logout</button>
  </aside>

  <!-- MAIN (fixed, non-scrollable) -->
  <main class="main">

    <!-- Header -->
    <div class="header">
      <div>
        <div class="title">Smart Farm Dashboard</div>
        <div class="subtitle">Real-time crop & climate insights across India</div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
       <button id="themeToggle"
  class="card w-12 h-12 flex items-center justify-center rounded-full text-xl hover:scale-110 transition"
  title="Toggle theme">
  üåô
</button>

      </div>
    </div>

    <!-- KPI row -->
    <section class="kpi-row">
      <div class="kpi card" style="border-left-color:#10b981;">
        <div>
          <div class="meta">Crops</div>
          <div class="value">30</div>
          <div class="meta" style="margin-top:6px;">Active crop types</div>
        </div>
        <div style="text-align:right;">
          <div class="trend" style="background:#ecfdf5;color:#065f46;">‚ñ≤ 4%</div>
        </div>
      </div>

      <div class="kpi card" style="border-left-color:#60a5fa;">
        <div>
          <div class="meta">Fields</div>
          <div class="value">48</div>
          <div class="meta" style="margin-top:6px;">Monitored fields</div>
        </div>
        <div style="text-align:right;">
          <div class="trend" style="background:#eff6ff;color:#1e3a8a;">Stable</div>
        </div>
      </div>

      <div class="kpi card" style="border-left-color:#fb923c;">
        <div>
          <div class="meta">Diseases</div>
          <div class="value">30</div>
          <div class="meta" style="margin-top:6px;">Active alerts</div>
        </div>
        <div style="text-align:right;">
          <div class="trend" style="background:#fff7ed;color:#92400e;">High risk: 7</div>
        </div>
      </div>

      <div class="kpi card" style="border-left-color:#f59e0b;">
        <div>
          <div class="meta">Yield Index</div>
          <div class="value">78</div>
          <div class="meta" style="margin-top:6px;">Projected yield score</div>
        </div>
        <div style="text-align:right;">
          <div class="trend" style="background:#fffbeb;color:#92400e;">+6%</div>
        </div>
      </div>
    </section>

    <!-- Content: Map (left) + Chart (right) -->
    <section class="content">

      <!-- Map column -->
      <div class="map-card card">
        <div class="map-toolbar">
          <div>
            <h3 class="text-lg font-semibold">India Crop Map</h3>
            <div class="meta">Hover states to view top crop production</div>
          </div>

          <!-- Toggle: switch tile layers (Street / Satellite) -->
          <div class="toggle" role="toolbar" aria-label="Map tile toggle">
            <button id="btnStreet" class="active" aria-pressed="true">Street</button>
            <button id="btnSatellite" aria-pressed="false">Satellite</button>
          </div>
        </div>

        <div id="map" class="map-canvas"></div>
      </div>

      <!-- Chart column -->
      <div class="chart-card card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <h3 class="text-lg font-semibold">State-wise Top Crops</h3>
            <div class="meta">Cultivation quantity (MT)</div>
          </div>
          <div class="meta">Top states</div>
        </div>

        <div class="chart-inner">
          <canvas id="cropChart" style="width:100%;height:100%;max-height:260px;"></canvas>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
  // Logout (unchanged)
  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  // Theme toggle (visual only)
  const themeToggle = document.getElementById('themeToggle');
let dark = false;

themeToggle.addEventListener('click', () => {
  dark = !dark;

  if (dark) {
    // Dark mode
    document.documentElement.style.setProperty('--bg-start', '#071021');
    document.documentElement.style.setProperty('--bg-end', '#04101a');
    document.documentElement.style.setProperty('--card-bg', 'rgba(10,14,20,0.75)');
    document.documentElement.style.setProperty('--muted', '#9ca3af');
    document.documentElement.style.setProperty('--accent', '#06b58a');

    themeToggle.innerHTML = "üåû";   // show sun
  } 
  else {
    // Light mode
    document.documentElement.style.setProperty('--bg-start', '#f6fbfb');
    document.documentElement.style.setProperty('--bg-end', '#eef6f4');
    document.documentElement.style.setProperty('--card-bg', 'rgba(255,255,255,0.98)');
    document.documentElement.style.setProperty('--muted', '#6b7280');
    document.documentElement.style.setProperty('--accent', '#0fb07f');

    themeToggle.innerHTML = "üåô";   // show moon
  }

  setTimeout(() => map.invalidateSize(), 200);
});


  /* ---------------------------
     Map: Leaflet with two tile layers
     - Map interactive; toggle switches tile layer
     - Ensure map fits fixed container (invalidateSize)
     --------------------------- */
  const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([22.5, 80], 5);

  // Street (OpenStreetMap)
  const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });

  // Satellite (Esri World Imagery)
  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });

  // Start with street
  street.addTo(map);

  // Sample state data (kept from your original)
  const stateData = {
    "Tamil Nadu": {crop:"Rice", quantity: 1500},
    "Maharashtra": {crop:"Sugarcane", quantity: 2200},
    "Karnataka": {crop:"Coffee", quantity: 900},
    "Kerala": {crop:"Coconut", quantity: 1200},
    "Gujarat": {crop:"Cotton", quantity: 1800},
    "Rajasthan": {crop:"Wheat", quantity: 2000},
    "Uttar Pradesh": {crop:"Sugarcane", quantity: 2400},
    "Madhya Pradesh": {crop:"Soybean", quantity: 1300},
    "West Bengal": {crop:"Rice", quantity: 1700},
    "Bihar": {crop:"Maize", quantity: 1100},
    "Punjab": {crop:"Wheat", quantity: 1900},
    "Haryana": {crop:"Wheat", quantity: 1600},
    "Odisha": {crop:"Rice", quantity: 1400},
    "Assam": {crop:"Tea", quantity: 800}
  };

  // Simplified GeoJSON (kept from your original)
  const indiaGeoJSON = {
    "type":"FeatureCollection","features":[
      {"type":"Feature","properties":{"name":"Tamil Nadu"},"geometry":{"type":"Polygon","coordinates":[[[77,10],[79,10],[79,12],[77,12],[77,10]]]}} ,
      {"type":"Feature","properties":{"name":"Maharashtra"},"geometry":{"type":"Polygon","coordinates":[[[73,17],[78,17],[78,22],[73,22],[73,17]]]}} ,
      {"type":"Feature","properties":{"name":"Karnataka"},"geometry":{"type":"Polygon","coordinates":[[[74,13],[78,13],[78,17],[74,17],[74,13]]]}} ,
      {"type":"Feature","properties":{"name":"Kerala"},"geometry":{"type":"Polygon","coordinates":[[[75,8],[77,8],[77,12],[75,12],[75,8]]]}} ,
      {"type":"Feature","properties":{"name":"Gujarat"},"geometry":{"type":"Polygon","coordinates":[[[68,20],[76,20],[76,25],[68,25],[68,20]]]}} ,
      {"type":"Feature","properties":{"name":"Rajasthan"},"geometry":{"type":"Polygon","coordinates":[[[69,23],[78,23],[78,30],[69,30],[69,23]]]}} ,
      {"type":"Feature","properties":{"name":"Uttar Pradesh"},"geometry":{"type":"Polygon","coordinates":[[[77,24],[84,24],[84,28],[77,28],[77,24]]]}} ,
      {"type":"Feature","properties":{"name":"Madhya Pradesh"},"geometry":{"type":"Polygon","coordinates":[[[74,21],[82,21],[82,26],[74,26],[74,21]]]}} ,
      {"type":"Feature","properties":{"name":"West Bengal"},"geometry":{"type":"Polygon","coordinates":[[[86,21],[89,21],[89,24],[86,24],[86,21]]]}} ,
      {"type":"Feature","properties":{"name":"Bihar"},"geometry":{"type":"Polygon","coordinates":[[[83,24],[88,24],[88,27],[83,27],[83,24]]]}} ,
      {"type":"Feature","properties":{"name":"Punjab"},"geometry":{"type":"Polygon","coordinates":[[[73,29],[77,29],[77,32],[73,32],[73,29]]]}} ,
      {"type":"Feature","properties":{"name":"Haryana"},"geometry":{"type":"Polygon","coordinates":[[[75,28],[78,28],[78,31],[75,31],[75,28]]]}} ,
      {"type":"Feature","properties":{"name":"Odisha"},"geometry":{"type":"Polygon","coordinates":[[[83,19],[87,19],[87,22],[83,22],[83,19]]]}} ,
      {"type":"Feature","properties":{"name":"Assam"},"geometry":{"type":"Polygon","coordinates":[[[90,25],[94,25],[94,27],[90,27],[90,25]]]}} 
    ]
  };

  // Color scale for fill
  function colorForQty(q) {
    if (q > 2200) return '#064e3b';
    if (q > 1900) return '#065f46';
    if (q > 1600) return '#059669';
    if (q > 1200) return '#10b981';
    return '#86efac';
  }

  // Add GeoJSON layer with tooltips and hover style
  const geoLayer = L.geoJSON(indiaGeoJSON, {
    style: feature => {
      const name = feature.properties.name;
      const info = stateData[name];
      const qty = info ? info.quantity : 0;
      return { fillColor: colorForQty(qty), color: '#0b1220', weight: 0.6, fillOpacity: 0.9 };
    },
    onEachFeature: (feature, layer) => {
      const s = feature.properties.name;
      const info = stateData[s] || {crop:'N/A', quantity:0};
      layer.bindTooltip(`<strong>${s}</strong><br>${info.crop} ‚Ä¢ ${info.quantity} MT`, {sticky:true, direction:'top', className:'text-sm'});
      layer.on('mouseover', ()=> layer.setStyle({weight:1.6, fillOpacity:1}));
      layer.on('mouseout', ()=> layer.setStyle({weight:0.6, fillOpacity:0.9}));
      layer.on('click', ()=> {
        layer.bindPopup(`<div style="min-width:160px"><strong>${s}</strong><div style="font-size:13px;color:#475569;">Top crop: ${info.crop}</div><div style="font-size:13px;color:#475569;">Production: ${info.quantity} MT</div></div>`).openPopup();
      });
    }
  }).addTo(map);

  // Toggle tile layers
  const btnStreet = document.getElementById('btnStreet');
  const btnSatellite = document.getElementById('btnSatellite');

  function setActiveButton(activeBtn) {
    [btnStreet, btnSatellite].forEach(b => b.classList.remove('active'));
    activeBtn.classList.add('active');
    btnStreet.setAttribute('aria-pressed', btnStreet === activeBtn ? 'true' : 'false');
    btnSatellite.setAttribute('aria-pressed', btnSatellite === activeBtn ? 'true' : 'false');
  }

  btnStreet.addEventListener('click', () => {
    if (!map.hasLayer(street)) map.addLayer(street);
    if (map.hasLayer(satellite)) map.removeLayer(satellite);
    setActiveButton(btnStreet);
    setTimeout(()=> map.invalidateSize(), 120);
  });

  btnSatellite.addEventListener('click', () => {
    if (!map.hasLayer(satellite)) map.addLayer(satellite);
    if (map.hasLayer(street)) map.removeLayer(street);
    setActiveButton(btnSatellite);
    setTimeout(()=> map.invalidateSize(), 120);
  });

  // Ensure initial active state
  setActiveButton(btnStreet);

  /* ---------------------------
     Chart: horizontal bar (state vs quantity)
     --------------------------- */
  const ctx = document.getElementById('cropChart').getContext('2d');
  const stateNames = Object.keys(stateData);
  const cropQty = Object.values(stateData).map(d => d.quantity);
  const cropColors = Object.values(stateData).map(d => {
    const colors = {Rice:'#ef4444',Wheat:'#16a34a',Sugarcane:'#3b82f6',Coffee:'#f59e0b',Coconut:'#fbbf24',Cotton:'#8b5cf6',Soybean:'#ec4899',Maize:'#06b6d4',Tea:'#facc15'};
    return colors[d.crop] || '#94a3b8';
  });

  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: stateNames,
      datasets: [{
        label: 'Cultivation Quantity (MT)',
        data: cropQty,
        backgroundColor: cropColors,
        borderRadius: 8,
        barThickness: 16
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const state = context.label;
              const d = stateData[state];
              return `${d.crop} ‚Äî ${d.quantity} MT`;
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Cultivation Quantity (MT)' }, grid: { color: 'rgba(2,6,23,0.04)' } },
        y: { title: { display: true, text: 'States' }, grid: { display: false } }
      }
    }
  });

  // Resize map when layout changes (ensures map fills fixed container)
  function resizeMap() {
    setTimeout(() => { map.invalidateSize(); }, 200);
  }
  window.addEventListener('resize', resizeMap);
  // initial invalidate
  resizeMap();
</script>


</body>
</html>
